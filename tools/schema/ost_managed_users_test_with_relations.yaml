# Backend-Agnostic Schema File (SQLite-First Strategy)
# Generated by PocketBase Schema Extractor v2.0
# Created: 2025-08-11T00:00:00Z
# Updated: 2025-08-11T00:00:00Z
# Source: Enhanced example following SQLite-first strategy
# Description: Test table with proper SQLite-first field types and relationships

table: managed_users_test_relations
description: "Test managed user accounts following SQLite-first strategy with proper field types"

# Define dependencies for deployment validation
dependencies:
  - ost_organizations
  - rbac_organization_roles

fields:
  # Primary identifier (SQLite-first: always TEXT)
  - name: id
    type: text
    primaryKey: true
    description: "Unique identifier for the managed user record"

  # Multi-tenant isolation (REQUIRED per strategy guide)
  - name: organizationId
    type: text
    description: "Organization this user belongs to (foreign key reference)"
    required: true
    relationship:
      type: "single"
      collectionId: "ost_organizations"
      maxSelect: 1
      minSelect: 1
      cascadeDelete: false

  # Business logic fields
  - name: name
    type: text
    description: "Full display name of the user"
    required: true
    validation:
      min: 1
      max: 100

  - name: email
    type: text
    description: "User's email address for authentication"
    required: true
    validation:
      pattern: "^[\\w\\.-]+@[\\w\\.-]+\\.[a-zA-Z]{2,}$"

  - name: password
    type: text
    description: "Encrypted password for authentication"
    required: true
    validation:
      min: 8

  # Boolean fields (SQLite-first: use INTEGER 0/1)
  - name: isActive
    type: integer
    description: "Whether the user account is active (1=active, 0=inactive)"
    required: true
    default: 1

  # Enum fields (SQLite-first: store as TEXT)
  - name: status
    type: text
    description: "Current status of the user account"
    default: "active"

  # Role relationship (TEXT field with relationship)
  - name: roleId
    type: text
    description: "Primary role assigned to this user (foreign key reference)"
    required: false
    relationship:
      type: "single"
      collectionId: "rbac_organization_roles"
      maxSelect: 1
      minSelect: 0
      cascadeDelete: false

  # Additional user fields (proper SQLite types)
  - name: emailVisibility
    type: integer
    description: "Whether email is visible to other users (1=visible, 0=hidden)"
    required: true
    default: 0

  - name: verified
    type: integer
    description: "Whether user email is verified (1=verified, 0=unverified)"
    required: true
    default: 0

  - name: tokenKey
    type: text
    description: "Security token for password reset and verification"
    required: true

  - name: userName
    type: text
    description: "Unique username for the user"
    validation:
      min: 3
      max: 30
      pattern: "^[a-zA-Z0-9._-]+$"

  # REQUIRED AUDIT TRAIL FIELDS (per strategy guide)
  - name: createdBy
    type: text
    description: "User ID who created this record"
    required: true

  - name: updatedBy
    type: text
    description: "User ID who last updated this record"
    required: true

  - name: createdAt
    type: text
    description: "ISO timestamp when record was created (UTC)"

  - name: updatedAt
    type: text
    description: "ISO timestamp when record was last updated (UTC)"

  - name: deletedAt
    type: text
    description: "ISO timestamp when record was soft deleted (nullable)"

  # REQUIRED SYNC METADATA FIELDS (per SyncableModel)
  - name: lastSyncedAt
    type: text
    description: "Last successful sync timestamp with remote server (ISO format)"

  - name: isDirty
    type: integer
    description: "1 if pending sync, 0 if clean"
    required: true
    default: 1

  - name: syncVersion
    type: integer
    description: "Incremental sync version number"
    required: true
    default: 0

  - name: isDeleted
    type: integer
    description: "1 if soft deleted, 0 if active"
    required: true
    default: 0

# Suggested indexes for performance optimization
indexes:
  - fields: [organization]
    name: idx_managed_users_organization
  - fields: [email]
    name: idx_managed_users_email
    unique: true
  - fields: [organization, isActive]
    name: idx_managed_users_org_active
  - fields: [role]
    name: idx_managed_users_role
  - fields: [isActive, isDeleted]
    name: idx_managed_users_status
